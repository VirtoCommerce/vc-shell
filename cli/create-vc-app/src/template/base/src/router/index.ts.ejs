import { createRouter, createWebHashHistory, RouteRecordRaw } from "vue-router";
import { inject } from "vue";
import {
  usePermissions,
  useUser,
  BladePageComponent,
  notification,
  useBladeNavigation,
  <% if(commonPages === true) { -%>
  Login,
  ResetPassword,
  Invite,
  <% } -%>} from "@vc-shell/framework";
  import { useCookies } from "@vueuse/integrations/useCookies";

/**
 * Pages
 */
<% if(dashboard === true) { -%>
import Dashboard from "../pages/Dashboard.vue";
<% } -%>
import App from "./../pages/App.vue";

// eslint-disable-next-line import/no-unresolved
import whiteLogoImage from "/assets/logo-white.svg";
// eslint-disable-next-line import/no-unresolved
import bgImage from "/assets/background.jpg";

const routes: RouteRecordRaw[] = [
  {
    path: "/",
    component: App,
    name: "App",
    meta: {
      root: true,
    },
    children: [
    <% if(dashboard === true) { -%>
      {
        name: "Dashboard",
        path: "",
        alias: "/",
        component: Dashboard,
      },
    <% } -%>
    ],
  },
  <% if(commonPages === true) { -%>
  {
    path: "/login",
    name: "Login",
    component: Login,
    props: () => ({
      logo: whiteLogoImage,
      background: bgImage,
      title: "<%= appName %>",
    }),
  },
  {
    name: "invite",
    path: "/invite",
    component: Invite,
    props: (route) => ({
      userId: route.query.userId,
      token: route.query.token,
      userName: route.query.userName,
    }),
  },
  {
    name: "resetpassword",
    path: "/resetpassword",
    component: ResetPassword,
    props: (route) => ({
      userId: route.query.userId,
      token: route.query.token,
      userName: route.query.userName,
    }),
  },
  <% } -%>
  {
    path: "/:pathMatch(.*)*",
    component: App,
    beforeEnter: (to) => {
      const { resolveUnknownRoutes } = useBladeNavigation();

      return resolveUnknownRoutes(to);
    },
  },
];

export const router = createRouter({
  history: createWebHashHistory(import.meta.env.APP_BASE_PATH as string),
  routes,
});

router.beforeEach(async (to, from) => {
  const { fetchUserPermissions, checkPermission } = usePermissions();
  const { resolveBlades } = useBladeNavigation();
  const { getAccessToken } = useUser();

  const pages = inject<BladePageComponent[]>("pages");

  const resolvedBladeUrl = resolveBlades(to);

  try {
    const token = await getAccessToken();
    <% if(commonPages === true) { -%>
    const azureAdCookie = useCookies([".AspNetCore.Identity.Application"]).get(".AspNetCore.Identity.Application");

    // Fetching permissions if not any
    if (token) await fetchUserPermissions();
    <% } -%>

    const component = pages.find((blade) => blade?.url === to.path);

    <% if(commonPages === true && bladeModuleStarter === true) { -%>
    const hasAccess = checkPermission(component?.permissions);

    if (!(token || azureAdCookie) && to.name !== "Login") {
      return { name: "Login" };
    } else if (hasAccess && to.name !== "Login") {
      return resolvedBladeUrl ? resolvedBladeUrl : true;
    } else if (!hasAccess) {
      notification.error("Access restricted", {
        timeout: 3000,
      });
      return from.path;
    }
    <% } -%>

    <% if(commonPages === true && bladeModuleStarter === false) { -%>
      if (!(token || azureAdCookie) && to.name !== "Login") {
        return { name: "Login" };
      }
    <% } -%>

    <% if(commonPages === false && bladeModuleStarter === true) { -%>
      return resolvedBladeUrl ? resolvedBladeUrl : true;
    <% } -%>

  } catch (e) {
    throw new Error(e.message);
  }
});

